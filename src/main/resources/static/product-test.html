<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒí’ˆ í†µí•© í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: Arial, sans-serif; }
    .product-card {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 16px;
      width: 300px;
      cursor: pointer;
    }
    .product-image {
      width: 100%;
      height: auto;
      max-height: 200px;
      object-fit: cover;
    }
    .section { margin-bottom: 40px; }
    .detail-section {
      margin-top: 40px;
      padding: 20px;
      border: 2px solid #444;
      max-width: 600px;
    }
    .image-scroll {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      margin-bottom: 12px;
    }
    .image-scroll img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div style="margin-bottom: 20px;">
  <button onclick="checkSession()">ğŸ” ì„¸ì…˜ ì²´í¬</button>
  <button onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</div>

<h1>ìƒí’ˆ ë“±ë¡</h1>
<div class="section">
  <form id="productForm" enctype="multipart/form-data">
    <input type="text" name="title" placeholder="ì œëª©" required><br>
    <textarea name="description" placeholder="ì„¤ëª…" required></textarea><br>
    <input type="number" name="originalPrice" placeholder="ì •ê°€" required><br>
    <input type="number" name="salePrice" placeholder="íŒë§¤ê°€" required><br>
    <input type="number" name="quantity" placeholder="ìˆ˜ëŸ‰" required><br>
    <input type="text" name="location" placeholder="ê±°ë˜ ì¥ì†Œ" required><br>
    <input type="text" name="openChatUrl" placeholder="ì˜¤í”ˆì±„íŒ… URL" required><br>
    <select name="type" required>
      <option value="">-- ê±°ë˜ ìœ í˜• ì„ íƒ --</option>
      <option value="CAFE">ì¹´í˜ ê±°ë˜</option>
      <option value="DIRECT">ì§ê±°ë˜</option>
    </select><br><br>
    <input type="file" name="images" id="imageInput" multiple><br><br>
    <button type="submit">ìƒí’ˆ ë“±ë¡</button>
  </form>
</div>

<hr>

<h1>ìƒí’ˆ ëª©ë¡</h1>
<div class="section">
  <label for="typeFilter">ê±°ë˜ ìœ í˜•: </label>
  <select id="typeFilter">
    <option value="">ì „ì²´</option>
    <option value="CAFE">ì¹´í˜ ê±°ë˜</option>
    <option value="DIRECT">ì§ê±°ë˜</option>
  </select>
  <button onclick="fetchProducts()">ì¡°íšŒ</button>
  <button onclick="fetchFavorites()">â­ ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°</button>
  <button onclick="fetchSellList()">ğŸ“¦ ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ</button>
  <div id="productList"></div>
</div>

<h2>ìƒí’ˆ ìƒì„¸ì •ë³´</h2>
<div id="productDetail" class="detail-section">
  <em>ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</em>
</div>

<h2>ìƒí’ˆ ìˆ˜ì • ë° ì‚­ì œ</h2>
<div id="editSection" class="detail-section">
  <h3>ìˆ˜ì •/ì‚­ì œ ëŒ€ìƒ ìƒí’ˆ ID: <span id="editProductId">ì„ íƒ ì „</span></h3>
  <form id="editForm">
    <input type="text" name="title" placeholder="ì œëª© ìˆ˜ì •"><br>
    <textarea name="description" placeholder="ì„¤ëª… ìˆ˜ì •"></textarea><br>
    <input type="number" name="originalPrice" placeholder="ì •ê°€ ìˆ˜ì •"><br>
    <input type="number" name="salePrice" placeholder="íŒë§¤ê°€ ìˆ˜ì •"><br>
    <input type="number" name="quantity" placeholder="ìˆ˜ëŸ‰ ìˆ˜ì •"><br>
    <input type="text" name="location" placeholder="ê±°ë˜ ì¥ì†Œ ìˆ˜ì •"><br>
    <input type="text" name="openChatUrl" placeholder="ì˜¤í”ˆì±„íŒ… URL ìˆ˜ì •"><br>
    <select name="type">
      <option value="">-- ê±°ë˜ ìœ í˜• ì„ íƒ --</option>
      <option value="CAFE">ì¹´í˜ ê±°ë˜</option>
      <option value="DIRECT">ì§ê±°ë˜</option>
    </select><br><br>
    <button type="submit">ìƒí’ˆ ìˆ˜ì •</button>
    <button type="button" onclick="deleteProduct()">ìƒí’ˆ ì‚­ì œ</button>
  </form>
</div>

<script>
  let selectedProductId = null;

  document.getElementById('productForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData();
    const dto = {
      title: form.title.value,
      description: form.description.value,
      originalPrice: form.originalPrice.value,
      salePrice: form.salePrice.value,
      quantity: form.quantity.value,
      location: form.location.value,
      openChatUrl: form.openChatUrl.value,
      type: form.type.value
    };
    formData.append("requestDto", new Blob([JSON.stringify(dto)], { type: "application/json" }));
    for (let i = 0; i < form.images.files.length; i++) {
      formData.append("images", form.images.files[i]);
    }
    const response = await fetch("/api/products",
      {
      method: "POST",
      body: formData,
      credentials: 'include'
      }
      );

    if (response.ok) {
      alert("ë“±ë¡ ì™„ë£Œ");
      form.reset();
      fetchProducts();
    } else {
      alert("ë“±ë¡ ì‹¤íŒ¨");
    }
  });

  async function fetchProducts() {
    const type = document.getElementById('typeFilter').value;
    const url = type ? `/api/products?type=${type}` : `/api/products`;
    const res = await fetch(url);
    const data = await res.json();
    renderProductList(data);
  }

  async function fetchFavorites() {
    const res = await fetch("/api/products/favorites");

    if (res.status === 401) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!res.ok) {
      const errText = await res.text();
      alert("ìš”ì²­ ì‹¤íŒ¨: " + errText);
      return;
    }

    const data = await res.json();
    renderProductList(data);
  }

  function renderProductList(products) {
    const list = document.getElementById('productList');
    list.innerHTML = '';
    if (products.length === 0) {
      list.innerHTML = '<p>ì¡°íšŒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }
    products.forEach(product => {
      const div = document.createElement('div');
      div.className = 'product-card';
      const star = product.favorited ? 'â­' : 'â˜†';
      const label = product.favorited ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ë“±ë¡';
      div.innerHTML = `
        <img class="product-image" src="${product.thumbnail}" alt="ì¸ë„¤ì¼"><br>
        <strong>${product.title}</strong><br>
        ê°€ê²©: <strong>${product.salePrice.toLocaleString()}ì›</strong><br>
        íŒë§¤ì: ${product.sellerName}<br>
        ë“±ë¡ ì‹œê°„: ${product.timeAgo}<br>
        ìœ„ì¹˜: ${product.location}<br>
        <button onclick="toggleFavorite(${product.id}, this)">${star} ${label}</button>
      `;
      div.addEventListener('click', () => fetchProductDetail(product.id));
      list.appendChild(div);
    });
  }

  async function fetchProductDetail(productId) {
    const response = await fetch(`/api/products/${productId}`);
    const product = await response.json();
    selectedProductId = productId;
    document.getElementById('editProductId').innerText = productId;

    const detail = document.getElementById('productDetail');
    detail.innerHTML = `
      <h3>${product.title}</h3>
      <div class="image-scroll">
        ${product.images.map(img => `<img src="/images/${img.storedName}" alt="ì´ë¯¸ì§€">`).join('')}
      </div>
      <strong>íŒë§¤ì:</strong> ${product.sellerName}<br>
      <strong>ì •ê°€:</strong> ${product.originalPrice.toLocaleString()}ì›<br>
      <strong>íŒë§¤ê°€:</strong> ${product.salePrice.toLocaleString()}ì›<br>
      <strong>ìˆ˜ëŸ‰:</strong> ${product.quantity}<br>
      <strong>ê±°ë˜ìœ í˜•:</strong> ${product.type}<br>
      <strong>ì¥ì†Œ:</strong> ${product.location}<br>
      <strong>ìƒì„¸ì„¤ëª…:</strong><br>${product.description}<br>
      <strong>ì˜¤í”ˆì±„íŒ…:</strong> <a href="${product.openChatUrl}" target="_blank">ë°”ë¡œê°€ê¸°</a><br>
      <strong>ë“±ë¡ì‹œê°„:</strong> ${product.timeAgo}<br>
      <button onclick="toggleFavorite(${product.id}, this)">
        ${product.favorited ? "â­ ì¦ê²¨ì°¾ê¸° í•´ì œ" : "â˜† ì¦ê²¨ì°¾ê¸° ë“±ë¡"}
      </button>
    `;
  }

  async function toggleFavorite(productId, button) {
    const res = await fetch(`/api/products/${productId}/favorite`, {
      method: 'POST',
      credentials: 'include', // âœ… ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
    });

    if (res.status === 401) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!res.ok) {
      const errText = await res.text();
      alert("ìš”ì²­ ì‹¤íŒ¨: " + errText);
      return;
    }

    const result = await res.json();
    const isFavorited = result === true;
    if (button) {
      button.innerText = isFavorited ? 'â­ ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'â˜† ì¦ê²¨ì°¾ê¸° ë“±ë¡';
    }
    alert(isFavorited ? "ì¦ê²¨ì°¾ê¸° ë“±ë¡ë¨" : "ì¦ê²¨ì°¾ê¸° í•´ì œë¨");
  }


  async function deleteProduct() {
    if (!selectedProductId) return alert("ë¨¼ì € ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const res = await fetch(`/api/products/${selectedProductId}`, { method: 'DELETE', credentials: 'include' });

    if (res.status === 401) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!res.ok) {
      const errText = await res.text();
      alert("ìš”ì²­ ì‹¤íŒ¨: " + errText);
      return;
    }

    if (res.ok) {
      alert("ì‚­ì œ ì™„ë£Œ");
      document.getElementById('productDetail').innerHTML = '';
      document.getElementById('editProductId').innerText = 'ì„ íƒ ì „';
      fetchProducts();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨");
    }
  }

  async function checkSession() {
    const res = await fetch("/api/auth/session-check", {
      credentials: 'include'
    });
    const data = await res.json();
    alert(JSON.stringify(data, null, 2));
  }

  async function logout() {
    const res = await fetch("/api/auth/logout", {
      method: "POST",
      credentials: 'include'
    });

    if (res.ok) {
      alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
      location.reload();
    } else {
      alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
    }
  }

  async function fetchSellList() {
    const res = await fetch("/api/products/sell-list");

    if (res.status === 401) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
      return;
    }

    if (!res.ok) {
      const errText = await res.text();
      alert("ìš”ì²­ ì‹¤íŒ¨: " + errText);
      return;
    }

    const data = await res.json();
    renderProductList(data);
  }

  window.onload = fetchProducts;
</script>

</body>
</html>
